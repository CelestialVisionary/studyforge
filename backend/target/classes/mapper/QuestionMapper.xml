<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.exam.mapper.QuestionMapper">

    <!-- 题目结果映射 -->
    <resultMap id="QuestionResultMap" type="com.exam.entity.Question">
        <id column="id" property="id"/>
        <association property="answer" javaType="com.exam.entity.QuestionAnswer">
            <id column = "qa_id" property="id" />
            <result column="question_id" property="questionId" />
            <result column="answer" property="answer" />
            <result column="keywords" property="keywords" />
        </association>
        <collection property="choices" ofType="com.exam.entity.QuestionChoice"
            column="id" select="com.exam.mapper.QuestionChoiceMapper.selectListByQuestionId"
        />
    </resultMap>

    <!-- 分页查询题目列表 -->
    <select id="selectQuestionPage" resultMap="QuestionResultMap">
        select qs.*,
        qa.id qa_id,
        qa.question_id,
        qa.answer,
        qa.keywords,
        qa.create_time qa_create_time,
        qa.update_time qa_update_time,
        qa.is_deleted qa_is_deleted
        from questions qs left join question_answers qa on qs.id = qa.question_id and qa.is_deleted = 0
        where qs.is_deleted = 0
        <if test="queryVo.categoryId != null">
            AND qs.category_id = #{queryVo.categoryId}
        </if>
        <if test="queryVo.difficulty != null and queryVo.difficulty != ''">
            AND qs.difficulty = #{queryVo.difficulty}
        </if>
        <if test="queryVo.type != null and queryVo.type != ''">
            AND qs.type = #{queryVo.type}
        </if>
        <if test="queryVo.keyword != null and queryVo.keyword != ''">
            AND qs.title LIKE CONCAT('%', #{queryVo.keyword}, '%')
        </if>
        order by qs.create_time desc
    </select>

    <!-- 根据分类统计题目数量 -->
    <select id="selectCategoryQuestionCount" resultType="java.util.Map">
        select category_id, count(*) count 
        from questions 
        where is_deleted = 0 
        GROUP BY category_id
    </select>

</mapper>